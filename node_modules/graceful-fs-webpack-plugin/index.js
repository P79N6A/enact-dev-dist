var fs = require('graceful-fs');
var replaceable = ['mkdir', 'rmdir', 'unlink', 'writeFile'];

function GracefulFsPlugin(options) {
	this.options = options || {writeFile:true};
}

module.exports = GracefulFsPlugin;
GracefulFsPlugin.prototype.apply = function(compiler) {
	var opts = this.options;
	compiler.plugin('after-environment', function() {
		if(compiler.outputFileSystem
				&& compiler.outputFileSystem.constructor
				&& compiler.outputFileSystem.constructor.name === 'NodeOutputFileSystem') {
			for(var i=0; i<replaceable.length; i++) {
				if(opts[replaceable[i]] && compiler.outputFileSystem[replaceable[i]]) {
					compiler.outputFileSystem[replaceable[i]] = fs[replaceable[i]].bind(fs);
				}
			}
		}
	});
};
